# NijiLingo トーン差検証条件 v3（本番フロー版）

> 作成日: 2025-02-01
> 更新日: 2025-02-01
> 目的: **本番フロー（editJapaneseForTone + translateFull）** でトーン差100%達成を目指す

---

## 📋 検証フロー

```
┌─────────────────────────────────────────────────────────────┐
│  【Phase 1】ベンが自力で改善（5ラウンド）                   │
│  ├─ Round 1: 現在のプロンプト → テスト → 結果記録          │
│  ├─ Round 2: ベンが改修 → テスト → 結果記録                │
│  ├─ Round 3: ベンが改修 → テスト → 結果記録                │
│  ├─ Round 4: ベンが改修 → テスト → 結果記録                │
│  └─ Round 5: ベンが改修 → テスト → 結果記録                │
│                         ↓                                   │
│  【シュワちゃんレビュー①】                                 │
│  5回分まとめて投げてアドバイスもらう                        │
│                         ↓                                   │
│  【Phase 2】アドバイス反映して5ラウンド                     │
│  ├─ Round 6〜10                                             │
│                         ↓                                   │
│  【シュワちゃんレビュー②】                                 │
│  アドバイスもらう                                           │
│                         ↓                                   │
│  【繰り返し】100点達成まで                                  │
└─────────────────────────────────────────────────────────────┘
```

**⚠️ 重要: 1ラウンドずつ実行すること**
- 連続でラウンド5まで進めると途中で止まる
- 1ラウンド実行 → 結果確認 → プロンプト改善 → 次のラウンド
- 焦らず1個ずつ進める

**📊 1ラウンドの定義:**
- 両モデル（llama-4-scout, gpt-oss-120b）をまとめて実行
- 終わったら比較形式で出力
- 例: Round 1 = llama-4-scout R1 + gpt-oss-120b R1 → 比較表

**📝 プロンプト改修ルール:**
- テスト文に特化した例示は禁止
- 一般化したルール・パターンのみ使用
- 理由: 本番の多様な入力に対応するため（過学習防止）
- **悪化した場合はプロンプトを前のラウンドに戻す**
- **戻したら前の検証結果（失敗パターン）を見て、前回とは別のアプローチで改修してから次ラウンド実行**
- **改修時は「個別→一般化」アプローチを使う:**
  1. 失敗パターンごとに個別の解決策を考える
  2. 個別解決策から共通ルールを抽出して一般化
  3. 一般化したルールをプロンプトに追加

---

## ⚡ 検証方法

### ベン（俺）がAPI直接叩いてテストする

アプリのUIを使わず、**ベンがスクリプトでAPIを直接叩いて検証**する。

### 使用モデル

| モデル | API | 特徴 |
|--------|-----|------|
| **llama-4-scout** | Groq API | 高速 ← **Phase 3以降はこれのみ使用** |
| ~~gpt-oss-120b~~ | Groq API | 高精度（参考用） |

**⚡ Phase 3以降: llama-4-scoutのみで検証**
- 理由: 圧倒的に速い（gpt-oss-120bの約3倍）
- 本番採用決定済み
- gpt-oss-120bはPhase 2で30/30達成済み、今後は参考程度

---

## 🔄 本番フローの構造

```
┌─────────────────────────────────────────────────────────────┐
│  【本番フロー】                                             │
│                                                             │
│  1. 日本語入力（テスト文）                                  │
│           ↓                                                 │
│  2. editJapaneseForTone(日本語, tone, toneLevel)            │
│           ↓                                                 │
│     トーン編集された日本語                                  │
│           ↓                                                 │
│  3. translateFull(編集済み日本語 → 英語)                    │
│           ↓                                                 │
│     英語翻訳 + reverse_translation                          │
└─────────────────────────────────────────────────────────────┘
```

### Phase 1で俺がやってた方法（間違い）
```
日本語 → API（翻訳+逆翻訳を1回で同時生成）
```
↑ これは本番フローと違う

### 本番フロー（正しい）
```
日本語 → editJapaneseForTone → 編集済み日本語 → translateFull → 英語+逆翻訳
```
↑ 2段階処理

---

## 🧪 各ラウンドのテスト手順

### Step 1: テスト文を用意（10個）

| # | テスト文 | エラータイプ | 論文根拠 |
|---|----------|--------------|----------|
| 1 | 来週都合どう？ | ゼロ代名詞 | Wang et al. (2019) |
| 2 | この書類、確認お願いできますか | 敬語レベル | VEQTA (2024) |
| 3 | おうたが寝てから向かいます | 名詞認識エラー | VEQTA (2024) |
| 4 | これ、ちょっと見てもらえる？ | Modality変換 | Hayakawa & Arase (2020) |
| 5 | ありがとう | 短すぎる文 | Schmidtová et al. (2025) |
| 6 | 明日会議に行きます | 主語省略（ゼロ照応） | Wang et al. (2019) |
| 7 | お疲れ様でした | 英語で差がつけにくい敬語 | Colorado (2022) |
| 8 | もう行っちゃったの？ | 時制・相 | VEQTA (2024) |
| 9 | また今度ね | ゼロ代名詞＋依頼 | Wang et al. (2019) |
| 10 | それなんかいいね | カジュアル特有の省略 | TACL (2025) |

### Step 2: 本番フローを実行

```
各テスト文 × 各トーン(casual/business/formal) × 各レベル(0%/50%/100%)

1. editJapaneseForTone(テスト文, tone, level)
   → トーン編集された日本語

2. translateFull(編集済み日本語 → 英語)
   → 英語翻訳 + reverse_translation
```

### Step 3: 評価（4つの観点）

本番フローの各ステップで評価する：

| 観点 | 対象 | 合格条件 | 不合格例 |
|------|------|----------|----------|
| ① 部分生成 | editJapaneseForTone | 日本語が正しく編集されている | 編集されてない、不自然な編集 |
| ② 翻訳 | translateFull | 英語翻訳が正しい | 文法ミス、意味が違う |
| ③ トーン差 | 全体 | 0%/50%/100%で**全て異なる表現** | 同じ表現が2つ以上 |
| ④ 品質 | 日本語・英語 | 自然で正しい表現 | 二重語尾、文法崩壊、日本語混入 |

**評価方法:**
- 1レベル（例：casual 50%）で4観点全てOK → ✅（1点）
- 1つでも不合格 → ❌（0点）

**点数計算:**
```
1レベル = 1点（4観点全てOKの場合）
1トーン = 3レベル（0%/50%/100%）= 3点満点
1文章 = 3トーン = 9点満点
10文章 = 90点満点
```

**API速度の記録（必須）:**
- 各テストで `editJapaneseForTone` + `translateFull` の合計時間を記録
- 平均速度、最速、最遅をサマリーに記載
- モデル間の速度比較にも使用

### Step 4: 結果記録

各ラウンドで以下を記録：
1. 使用したプロンプト（変更点）
2. スコア（○/90）
3. 失敗したパターン
4. 具体的な出力例（失敗したやつ）
5. **不合格理由を4観点で明記:**
   - ① 部分生成の問題？（editJapaneseForToneが正しく編集してない）
   - ② 翻訳の問題？（translateFullの英語が間違ってる）
   - ③ トーン差の問題？（0%/50%/100%で同じ表現）
   - ④ 品質の問題？（日本語/英語が不自然）
6. API速度（平均・最速・最遅）
7. 次の改善ポイント

### Step 5: プロンプト改修

シュワちゃん改善案を参考に改修：
- `editJapaneseForTone` のシステムプロンプト（JAPANESE_EDIT_SYSTEM_PROMPT）
- `translateFull` のシステムプロンプト
- Few-shot例示の追加
- 語尾ガイド表
- トーン必須要素の明確化

---

## 📊 現在のAPI基準点（Baseline）

新テスト文 + 改善版プロンプトでの基準点：

| モデル | スコア | casual | business | formal | 平均速度 |
|--------|--------|--------|----------|--------|----------|
| gpt-4.1-nano | **30/30 (100%)** ✅ | 10/10 | 10/10 | 10/10 | 3689ms |
| llama-4-scout | - | - | - | - | - |
| gpt-oss-120b | - | - | - | - | - |

> 詳細: `tests/results/phase2-production/roundbaseline_gpt-4.1-nano.md`

---

## 🎯 トーン × レベル（9パターン）

| トーン | 0% | 50% | 100% |
|--------|-----|-----|------|
| casual | ✓ | ✓ | ✓ |
| business | ✓ | ✓ | ✓ |
| formal | ✓ | ✓ | ✓ |

---

## 🔧 改修の参考資料

ベンが改修する時の参考：
- `tests/improved_prompt_v2.md`（シュワちゃん改善案）
- `tests/results/phase1/phase1_summary.md`（Phase 1の結果）
- Few-shot例示の追加
- FORMAL 100%必須要素の明確化
- 逆翻訳語尾ルールの具体化

---

## 📤 シュワちゃんへの提出形式（5ラウンドごと）

```markdown
# NijiLingo 本番フロー トーン差検証 - Phase X レビュー依頼

## 📋 実験概要
- 日付: YYYY-MM-DD
- テスト者: ベン（API直叩き）
- フロー: editJapaneseForTone → translateFull
- モデル: llama-4-scout / gpt-oss-120b

## 📊 結果サマリー
| Round | スコア | 主な問題 | 平均速度 |
|-------|--------|----------|----------|
| 1 | ?/90 | ... | ?ms |
| 2 | ?/90 | ... | ?ms |
| 3 | ?/90 | ... | ?ms |
| 4 | ?/90 | ... | ?ms |
| 5 | ?/90 | ... | ?ms |

## ① 4観点別の問題分析
| 観点 | 問題件数 | 詳細 |
|------|----------|------|
| 部分生成 | ?件 | ... |
| 翻訳 | ?件 | ... |
| トーン差 | ?件 | ... |
| 品質 | ?件 | ... |

## ② 各トーンの得意・苦手（詳細）
...

## ③ 改善が認められたプロンプト
...

## ④ 改善しなかったプロンプト
...

## ⑤ 現時点の最新プロンプト
...

## ⑥ API速度比較
| モデル | 平均 | 最速 | 最遅 |
|--------|------|------|------|
| llama-4-scout | ?ms | ?ms | ?ms |
| gpt-oss-120b | ?ms | ?ms | ?ms |

## 🎯 依頼
100点達成のための改善アドバイスをください
```

---

## 📁 ファイル構成

```
nijilingo-ai-knowledge/tests/
├── verification_conditions_v3_production.md  # このファイル（最新）
├── verification_conditions.md                # 旧版（Phase 1用）
├── tone_test_cases_v2.md                     # テスト文詳細
├── current_app_prompt.md                     # 現在のアプリプロンプト
├── improved_prompt_v2.md                     # シュワちゃん改善案
└── results/
    ├── phase1/                               # Phase 1結果（API直叩き1回版）
    │   └── phase1_summary.md
    └── phase2-production/                    # Phase 2結果（本番フロー版）
        ├── round1.md
        ├── round2.md
        ├── ...
        └── phase2_summary.md
```

---

## 📝 Round 1 スタート地点：現在のプロンプト

### 1️⃣ editJapaneseForTone のシステムプロンプト

```
あなたはNijiLingoの日本語編集モードです。
与えられた日本語文を、指定されたトーンレベルに合わせて編集してください。

【ルール】

1. 意味を変えない
   - 数字、名前、肯定/否定、質問/断定はそのまま
   - 依頼/義務/提案のクラスを変えない
   - 約束やお願いを追加しない
   - 感情の強さを変えない（OK→素晴らしい ❌）

2. 敬語の対象を間違えない
   - 人名の判断: 後ろに人の動作（寝る、来る、食べる等）が続くか
   - 敬称なし人名（太郎、花子）= 身内 → 敬語化しない
   - 敬称あり人名（田中様）= 他人 → 敬語化OK
   - 敬称を勝手に追加しない

3. 自然な日本語にする
   - 文法が正しいこと
   - 「じゃん」は確認・評価にのみ使う（未来の行動には使わない）

【トーンレベルガイド】
カジュアル:
- 50%: 「〜だね」「〜だよ」「〜してる」
- 100%: 「めっちゃ〜」「マジで〜」「〜よ！」

ビジネス:
- 50%: 「〜いたします」「〜でございます」
- 100%: 「〜申し上げます」「〜賜りますよう」

フォーマル:
- 50%: 「〜させていただきます」
- 100%: 「〜申し上げる所存でございます」

【良い例・悪い例】
元: 「太郎が寝てからあなたの家に行く」

✅ カジュアル: 太郎が寝てからあなたの家に行くね！
✅ カジュアル100%: 太郎が寝てからお前んち行くよ！
✅ ビジネス: 太郎が寝てからお宅に伺います
✅ フォーマル: 太郎が寝てから、お宅へ伺わせていただきます

❌ 太郎様がお休みになられましたら（身内に敬語）
❌ 何卒よろしくお願いいたします（意味追加）
❌ 行くじゃん！（「じゃん」の使い方が不自然）
❌ 微妙させていただきます（文法崩壊）

JSONのみ返してください（説明不要）:
{"edited_japanese":"..."}
```

### editJapaneseForTone のユーザープロンプト

```
元の日本語: ${sourceText}

トーン: ${tone}
トーンレベル: ${toneLevel}%
目標スタイル: ${toneStyle}

この日本語を${toneLevel}%の${tone}トーンに編集してください。JSONのみ返してください。
```

---

### 2️⃣ translateFull のシステムプロンプト（主要部分）

```
あなたは${sourceLang}から${targetLang}への翻訳の専門家です。

【不変条件 - 翻訳時に絶対守ること】
1. entities - 数字、日付、時刻、金額、固有名詞を変えない
2. polarity - 肯定/否定を変えない
3. locked_terms - 用語集の語句をそのまま使う
4. modality_class - 依頼/義務/提案のクラスを変えない
5. question/statement - 質問/断定を変えない
6. condition markers - if/unless/when等を保持
7. commitment - 約束を勝手に追加しない
8. stance_strength - 同意や感情の強さを勝手に変えない

【トーン・評価語ルール】
1. トーンは口調のみ変更し、評価軸は変えない
2. cool/sick/dude/huh など評価軸を変える語は禁止
3. reverse_translation は意味を保持しつつ、トーン差を語尾で表現

【翻訳スタイル指示】
${toneInstruction}  ← トーン×レベル別の指示（getToneStyleInstruction関数で生成）

【逆翻訳ルール】
${reverseTranslationInstruction}  ← 語尾ガイド等（getReverseTranslationInstruction関数で生成）

JSON形式で出力：
{
  "translation": "英語のみ",
  "reverse_translation": "日本語のみ",
  "risk": "low|med|high"
}
```

### translateFull のユーザープロンプト

```
以下のテキストを翻訳してください（${tone}スタイル、強度${toneLevel}%）：

${sourceText}
```

---

### 🔄 本番フローでAIに投げる順番

```
【Step 1】editJapaneseForTone
入力: 「これ、いいね」 + casual + 50%
出力: {"edited_japanese": "これ、いいね〜"}

【Step 2】translateFull  
入力: 「これ、いいね〜」（編集済み） + casual + 50%
出力: {
  "translation": "This is nice!",
  "reverse_translation": "いいね〜",
  "risk": "low"
}
```

---

## ⏭️ 次のステップ

1. [ ] 本番フロー用テストスクリプト作成
2. [ ] Round 1 実行（上記の現在のプロンプト）
3. [ ] Round 2-5 ベンが改修しながら実行
4. [ ] Phase 1 結果をシュワちゃんに投げる
5. [ ] 繰り返し
6. [ ] 100点達成で最終レポート作成

---

*作成: ベン*
*日時: 2025-02-01 00:45 JST*
