# 🍎 NijiLingo 総合コード分析レポート

**分析者:** ベン（Clawdbot）
**日付:** 2026-01-29
**対象ファイル:** 
- `App_日本語ベース.tsx` (128KB)
- `groq_日本語ベース.ts` (65KB)

---

## 📋 アプリ仕様の理解

### 基本フロー
1. ユーザーが日本語を入力
2. トーン（カジュアル/ビジネス/超丁寧/カスタム）を選択
3. スライダーでレベル調整（0%/50%/100%の3段階UI）
4. 日本語→外国語に翻訳
5. 逆翻訳でニュアンスを確認

### 翻訳方式
- **日本語ベース方式:** 日本語をトーンに合わせて編集 → 翻訳
- **従来方式:** 英語を編集（外国語→日本語の場合）

---

## 🐛 発見したバグ・問題点

### 🔴 重大度: 高

#### 1. バックグラウンド処理のレースコンディション
**場所:** `App_日本語ベース.tsx` 1481-1495行目

```javascript
// 選択したトーン → 即座に処理
fetchAllBucketsForTone(toneId, isNative, undefined, targetLang, sourceLang)

// ★ 他のトーンは直列で事前生成（API詰まり防止）
const otherTones = ['casual', 'business', 'formal'].filter(t => t !== toneId)
setTimeout(async () => {
  for (const tone of otherTones) {
    await fetchAllBucketsForTone(tone, isNative, ...).catch(console.error)
  }
}, 0)
```

**問題:**
- `setTimeout(0)`で他トーンをバックグラウンド処理
- ユーザーが操作中にキャッシュが上書きされる可能性
- 「待つと結果が変わる」現象の原因

**修正案:**
```javascript
// 方法1: 選択したトーン以外は遅延実行しない
// 方法2: 処理中フラグを追加して衝突を防ぐ
// 方法3: AbortControllerで古い処理をキャンセル
```

---

#### 2. 超丁寧モードでLv2がLv1より敬語弱くなる
**場所:** `groq_日本語ベース.ts` のLazy生成ロジック

**問題:**
- UI 50%に対して内部25%/50%/75%から「最初にOKになったもの」を採用
- 品質チェックで「前と違う」ことを優先し、敬語レベルの一貫性を保証していない

**現象（検証結果より）:**
```
超丁寧 Lv1: 「その服は素敵でございますね。」
超丁寧 Lv2: 「その服は素敵ですね。」 ← 敬語下がってる！
超丁寧 Lv3: 「その服は素敵でございますね。」
```

**原因推定:**
- Lazy生成で25%が「ですね」を返し、それが「違う」と判定されて採用
- 本来は50%/75%の「でございますね」が欲しいのに、25%の軽い敬語が選ばれる

**修正案:**
```javascript
// トーンタイプ別に最低敬語レベルを保証
// formal/business は「ございます」系を必須にする
```

---

#### 3. カジュアルLv3で意味が変わる
**場所:** `groq_日本語ベース.ts` のPARTIAL_SYSTEM_PROMPT

**現象:**
```
入力: 「明日の会議の資料送ってもらえる？」
Lv3: "Are you sending the materials..." → 「送ってるね？」
期待: "Can you send me..." → 「送ってくれる？」
```

**問題:**
- トーン変更時に動詞の時制/相が変わってしまう
- 「依頼」が「確認」に変わっている（modality_class違反）

**修正案:**
- PARTIALプロンプトの「modality_class保持」ルールを強化
- 具体例を追加

---

### 🟡 重大度: 中

#### 4. ビジネストーンの差分が出にくい
**場所:** `groq_日本語ベース.ts` getToneStyleInstruction

**問題:**
```javascript
case 'business':
  if (toneLevel >= 50) {
    toneStyle = 'standard business (use "I would suggest...", ...)'
  } else {
    toneStyle = 'slightly business ...'
  }
```
- 50%と75%と100%の指示が同じ
- 差分が出にくい

**修正案:**
- 各レベルに具体的な例文を追加
- 75%と100%で明確に異なる指示を設定

---

#### 5. 二重語尾の発生
**場所:** `groq_日本語ベース.ts` fixDoubleEnding

**評価:** 
- 後処理で二重語尾を修正する仕組みはある ✅
- ただしパターンが多すぎて漏れがある可能性

---

## 📝 プロンプト分析

### 現在のPARTIAL_SYSTEM_PROMPT（要約）
```
- current_translationを編集してトーンを変える
- 意味を変えない（8つの不変条件）
- トーンレベル別の指示（0-24%, 25-49%, 50-74%, 75-99%, 100%）
- reverse_translationは日本語で、レベル差を語尾で表現
```

### 問題点

1. **レベル間の差分指示が抽象的**
   - 「Light application」「Normal application」「Heavy application」
   - 具体的な変化例がない

2. **逆翻訳ルールが複雑**
   - 複数の署名ルールが混在
   - モデルが従いにくい

### 推奨プロンプト改善

```
【トーンレベル - 具体例必須】
■ カジュアル
- 0%: "That outfit looks nice." → 「その服素敵だね」
- 50%: "That outfit looks really nice!" → 「その服、めっちゃ素敵だね！」
- 100%: "Wow, that outfit is so nice!" → 「うわ、その服めっちゃ素敵じゃん！」

■ ビジネス
- 0%: "That outfit is nice." → 「その服は素敵ですね。」
- 50%: "That is a lovely outfit." → 「その服は素敵でございますね。」
- 100%: "What a splendid outfit." → 「誠に素敵なお召し物でございますね。」

■ 超丁寧
- 0%: "That is a nice outfit." → 「その服は素敵でございます。」
- 50%: "That is a lovely outfit indeed." → 「その服は大変素敵でございますね。」
- 100%: "What a truly magnificent outfit." → 「誠に見事なお召し物でございます。」

【必須ルール】
- Lv50 は Lv0 より必ず丁寧/カジュアル
- Lv100 は Lv50 より必ず丁寧/カジュアル
- 段階を逆転させない
```

---

## 🔧 修正優先順位

| 優先度 | 問題 | 影響 | 修正難易度 |
|--------|------|------|------------|
| 1 | 超丁寧Lv2が弱い | 高 | 中 |
| 2 | カジュアルLv3で意味変化 | 高 | 低（プロンプト修正） |
| 3 | バックグラウンド処理の競合 | 中 | 中 |
| 4 | ビジネスの差分不足 | 中 | 低（プロンプト修正） |

---

## 🎯 次のアクション

### すぐにできること（プロンプト修正）

1. **PARTIAL_SYSTEM_PROMPTに具体例を追加**
   - 各トーン×各レベルの具体的な変換例
   - 「これはNG」の例も追加

2. **逆翻訳ルールの簡素化**
   - 現在の複雑な署名ルールを簡潔に
   - モデルが従いやすい形式に

### 中期的な修正（コード変更）

1. **Lazy生成ロジックの改善**
   - 敬語レベルの一貫性チェックを追加
   - formal/businessは敬語の最低ラインを保証

2. **バックグラウンド処理の改善**
   - 処理中フラグの追加
   - または事前生成の廃止

---

## 📚 参考: トーン調整に関する研究

翻訳のトーン調整は「Style Transfer」の一種。関連研究：

1. **Politeness Transfer** - 敬語レベルの変換
2. **Formality Style Transfer** - フォーマル⇔カジュアル
3. **Controlled Text Generation** - 制御された文生成

これらの研究では「意味を保持しながらスタイルを変える」ことが課題。
NijiLingoの「逆翻訳でニュアンス確認」は良いアプローチ。

---

**以上、ベンによる総合分析レポート**
