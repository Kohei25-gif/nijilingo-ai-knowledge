# NijiLingo 翻訳システム - 完全設計ガイド 要約

> ファイルから抽出・整理された主要コンテンツ

---

## 📋 ドキュメント概要

| 項目 | 内容 |
|------|------|
| **システム名** | NijiLingo 翻訳システム |
| **対象** | 日本語→英語翻訳（トーン調整可能） |
| **バージョン** | v2 |
| **目的** | 理想と現実、研究と実装の架け橋 |

---

## 1. 核心発見と問題定義

### 1.1 検証で判明した重要事実

```
┌─────────────────────────────────────────────────────────┐
│              【検証で判明した事実】                      │
├─────────────────────────────────────────────────────────┤
│ ✅ 日本語（逆翻訳）は段階的に変わっている               │
│    → 生成ロジック自体は成功している！                   │
│                                                         │
│ ❌ 問題は「英語出力が日本語の変化を反映していない」     │
│    → 「日英乖離」が核心問題                             │
└─────────────────────────────────────────────────────────┘
```

### 1.2 問題分類（重要！混同厳禁）

| 問題 | 現象 | 原因 | 対象 |
|------|------|------|------|
| **「操作しないと変わらない」** | スライダー動かしても表示が同じ | キャッシュ更新遅延 | UI表示 |
| **「待つと変わる」** | 少し待つと勝手に表示が変わる | バックグラウンド生成完了 | UI表示 |
| **「日英乖離」** | 日本語（逆翻訳）は変わるが英語（翻訳）は同じ | 翻訳と逆翻訳の生成タイミングずれ | **データ品質** |

### 1.3 問題一覧と優先度

| 優先度 | 問題名 | 根本原因 | 影響範囲 |
|--------|--------|----------|----------|
| 🔴 **最重要** | 日英乖離 | 翻訳と逆翻訳が別エージェントで生成、キャッシュキーずれ | データ品質 |
| 🔴 **最重要** | 操作しないと変わらない | 事前生成完了前にスライダー操作 | UI/UX |
| 🟡 **中** | 待つと変わる | バックグラウンド生成完了後にUI更新 | UI/UX |
| 🟡 **中** | 名詞誤認識 | 文脈解析なしの単純な翻訳 | 正確性 |
| 🟡 **中** | 主語省略誤解 | ゼロ照応解決ロジックなし | 正確性 |
| 🟢 **低** | modality変更 | PARTIAL編集の制約が緩い | 品質 |

---

## 2. 技術アーキテクチャ

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                      ユーザー層                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  入力フォーム │  │  トーンスライダー │  │  翻訳表示部  │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    アプリケーション層                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │              App.tsx (メインアプリ)              │   │
│  │  ┌──────────────┐  ┌──────────────────────────┐ │   │
│  │  │ 事前生成管理  │  │ キャッシュ管理システム    │ │   │
│  │  │ (generateAnd │  │ (UI Buckets)             │ │   │
│  │  │  CacheUiBuckets│  │                          │ │   │
│  │  └──────────────┘  └──────────────────────────┘ │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                      API層                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │           groq.ts (翻訳APIモジュール)            │   │
│  │  ┌──────────────┐  ┌──────────────────────────┐ │   │
│  │  │ プロンプト   │  │ Gemini APIクライアント    │ │   │
│  │  │ ビルダー     │  │ (callGeminiAPI)          │ │   │
│  │  └──────────────┘  └──────────────────────────┘ │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    分析モジュール層                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   ner.ts     │  │zeroAnaphora.ts│  │ modality.ts  │  │
│  │  名詞認識    │  │ ゼロ照応解決  │  │ Modality識別 │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    外部サービス層                        │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Gemini API (Google)                 │   │
│  │         (大規模言語モデルによる翻訳)              │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 2.2 ファイル構造

```
src/
├── App_日本語ベース.tsx    # メインアプリケーション
├── groq_日本語ベース.ts    # 翻訳API（プロンプト含む）
├── ner.ts                  # 名詞認識モジュール
├── zeroAnaphora.ts         # ゼロ照応解決モジュール
├── modality.ts             # Modality識別モジュール
└── promptBuilder.ts        # 統合プロンプトビルダー

analysis/                   # バグ分析
logs/                       # 検証ログ
tasks/todo.md              # タスク管理
```

---

## 3. 研究ベースのプロンプト設計

### 3.1 引用論文一覧

| 引用番号 | 論文タイトル | 研究分野 |
|---------|-------------|---------|
| [^7^] | "CodeNER: Code Prompting for Named Entity Recognition" | 固有表現認識（NER） |
| [^11^] | "Japanese Zero Anaphora Resolution using Machine Translation" | ゼロ照応解析 |
| [^2^] | "Multi-Agent System for High-Quality Translation" | 翻訳品質向上システム |

### 3.2 研究知見と適用

#### CodeNER研究 [^7^]
> 「タスクに特化したプロンプトを用いることで、LLMのNER性能が向上する」

**適用方法**: 翻訳前に名詞を4カテゴリに分類
- **人名（Person）**: 後ろに人間の動作が続く
- **組織名（Organization）**: 固有名詞＋組織を示す接尾辞
- **地名（Location）**: 場所を示す文脈
- **一般名詞（Common）**: 上記以外

#### ゼロ照応解決研究 [^11^]
> 「文脈情報（前後の文、敬語、動詞の意味属性）から省略主語を推定可能」

**推定の手順**:
1. 動詞の種類から主語を推定（来る・行く・帰る→移動する主体）
2. 敬語情報から主語を推定（尊敬語→相手、謙譲語→自分）
3. 文末の語尾から主語を推定（〜てください→相手、〜たい→自分）

#### Modality保持研究 [^2^]
> 「翻訳時に発話の意図（modality）を明示的にタグ付けすることで、意図の保持率が向上」

### 3.3 Modality分類体系

| Modalityクラス | マーカー（日本語） | 英語表現例 |
|--------------|------------------|-----------|
| **依頼（request）** | 〜てもらえる？ / 〜てくれる？ | "Can you...?" / "Could you...?" |
| **確認（confirmation）** | 〜してる？ / 〜なの？ | "Are you...?" / "Is it...?" |
| **提案（suggestion）** | 〜しない？ / 〜どう？ | "Why don't we...?" / "How about...?" |
| **義務（obligation）** | 〜しなきゃ / 〜すべき | "I need to..." / "I should..." |

---

## 4. コアモジュール実装

### 4.1 主要インターフェース

```typescript
// 翻訳結果
interface TranslationResult {
  translation: string;
  reverse_translation: string;
  risk: 'low' | 'med' | 'high';
  alignment_score?: number;  // 翻訳と逆翻訳の一致度
}

// NERエンティティ
interface Entity {
  text: string;
  type: 'Person' | 'Organization' | 'Location' | 'Common' | 'Product';
  confidence: number;
  start: number;
  end: number;
}

// ゼロ照応結果
interface ZeroAnaphoraResult {
  inferredSubject: string;
  confidence: number;
  reason: string;
}

// Modality結果
interface ModalityResult {
  class: 'request' | 'confirmation' | 'suggestion' | 'obligation' | 'statement';
  confidence: number;
  marker: string;
}
```

### 4.2 モジュール統合フロー

```
┌─────────────────────────────────────────────────────────────┐
│                      翻訳リクエスト                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  1. テキスト分析 (promptBuilder.analyzeText)                │
│     ├── NER (ner.extractEntities)                           │
│     ├── ゼロ照応 (zeroAnaphora.resolveZeroAnaphora)         │
│     └── Modality (modality.detectModality)                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  2. プロンプト構築 (promptBuilder.buildSystemPrompt)        │
│     ├── 基本プロンプト                                      │
│     ├── NERセクション                                       │
│     ├── ゼロ照応セクション                                  │
│     ├── Modalityセクション                                  │
│     └── トーン調整セクション                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  3. API呼び出し (groq.translateFull)                        │
│     ├── Gemini API呼び出し                                  │
│     ├── レスポンスパース                                    │
│     └── 翻訳-逆翻訳一致度チェック                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 結果返却                                                │
│     ├── translation                                         │
│     ├── reverse_translation                                 │
│     ├── risk                                                │
│     └── alignment_score                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 主要課題と解決策

### 5.1 課題1: 名詞認識問題

**問題例**:
```
【入力】おうたが寝てから向かいます。
【誤訳】"I'll go after singing sleeps."（おうた=singing）
【正解】"I'll head over after Ota goes to sleep."（おうた=人名Outa）
```

**原因**:
| 要因 | 説明 |
|------|------|
| ひらがな表記 | 「おうた」は「お歌（song）」とも読める |
| 文脈解析不足 | 後続の「寝てから」が人間の動作であることを無視 |
| NER未実装 | 固有名詞識別（Named Entity Recognition）がない |

### 5.2 課題2: 主語省略（ゼロ照応）

**問題例**:
```
【入力】明日会議に行きます。
【誤訳】"Tomorrow will go to the meeting."（主語なし）
【正解】"I will go to the meeting tomorrow." / "He will go..."（文脈依存）
```

**日本語の特殊性**:
| 言語 | 主語の扱い |
|------|-----------|
| 日本語 | pro-drop言語（省略可能） |
| 英語 | 主語必須 |

### 5.3 課題3: modality_class保持

**問題例**:
```
【入力】明日の会議の資料を送ってもらえる？
【誤訳】"Are you sending the materials for tomorrow's meeting?"（確認）
【正解】"Can you send me the materials for tomorrow's meeting?"（依頼）
```

---

## 6. 実装チェックリスト

### Phase 1: 基盤構築
- [ ] NERモジュール実装 (`ner.ts`)
- [ ] ゼロ照応モジュール実装 (`zeroAnaphora.ts`)
- [ ] Modalityモジュール実装 (`modality.ts`)
- [ ] プロンプトビルダー実装 (`promptBuilder.ts`)

### Phase 2: 統合
- [ ] `groq.ts`に分析モジュールを統合
- [ ] `App.tsx`の事前生成ロジック改善
- [ ] キャッシュ戦略の見直し

### Phase 3: 検証
- [ ] テストケース実行
- [ ] 名詞認識精度測定
- [ ] ゼロ照応解決精度測定
- [ ] Modality保持精度測定

### Phase 4: 最適化
- [ ] パフォーマンスチューニング
- [ ] エラーハンドリング強化
- [ ] ユーザーフィードバック収集

---

## 7. 検証テストケース

| # | テスト文 | 検証項目 |
|---|----------|----------|
| 1 | 「おうたが寝てから向かいます」 | 名詞認識（人名） |
| 2 | 「明日会議に行きます」 | ゼロ照応（主語補完） |
| 3 | 「資料を送ってもらえる？」 | modality保持（依頼） |
| 4 | 「遅れてごめん、電車が止まってた」 | トーン調整（カジュアル） |
| 5 | 「明日の会議の資料を送ってもらえる？」 | 統合テスト |

---

## 8. 改善サイクル

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  実装   │ → │  検証   │ → │  分析   │ → │  改善   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     ↑                                          │
     └──────────────────────────────────────────┘
```

---

## 9. 参考リソース

- **GitHubリポジトリ**: https://github.com/Kohei25-gif/nijilingo-ai-knowledge
- **メインアプリ**: https://github.com/Kohei25-gif/nijilingo-ai-knowledge/blob/main/src/App_日本語ベース.tsx
- **翻訳API**: https://github.com/Kohei25-gif/nijilingo-ai-knowledge/blob/main/src/groq_日本語ベース.ts

---

*このドキュメントは元の設計ガイドから主要コンテンツを抽出・整理したものです。*
