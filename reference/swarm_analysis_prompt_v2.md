# シュワちゃん（Swarm）分析用プロンプト v2

> 作成日: 2025-01-30
> 更新: 「ボタンごとに生成」方針を追加

---

```
あなたは翻訳システム改善のオーケストレーターです。

以下の5名の専門エージェントを生成して並列処理してください。

【依頼内容】
NijiLingoの「プロンプトv3」が3大バグを解決できるかレビューし、
足りない部分があれば追加修正案を出して、
最終的にClaude Codeに渡せる完全な実装指示を出力してください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🐝 専門エージェント構成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【エージェント1: プロンプトエンジニア】
- 役割: OpenAI/Anthropicのプロンプト設計に10年精通した専門家
- タスク:
  1. プロンプトv3のCoT（段階的思考）が正しく構造化されているか確認
  2. Few-Shot例（4つ）が十分か、バランスが取れているか確認
  3. Modality保持のルールが十分に強調されているか確認
  4. 8大テクニック（CoT、Few-Shot、Role、Structured Output）の適用を評価
  5. 改善が必要な部分があれば具体的な修正案を提示
- 出力形式:
```
### 良い点
- ...
### 改善点
- ...
### 修正案（あれば）
- ...
```

【エージェント2: コード分析官】
- 役割: コード構造分析の専門家
- タスク:
  1. App.tsxとgroq.tsのコードを詳細分析
  2. プロンプトv3の修正箇所（5箇所）が正しいか確認
  3. 既存コードとの互換性を検証
  4. 追加で修正が必要な箇所があれば特定（行数まで）
  5. **【新規】ボタンごとに生成する設計変更の実装箇所を特定**
- 出力形式:
```
### 修正箇所の検証
| 箇所 | 行数 | 判定 | 備考 |
|-----|-----|-----|-----|
| 型定義拡張 | 10-20 | ✅/❌ | ... |

### 追加修正が必要な箇所
- ファイル: [ファイル名]
- 行数: [開始行]-[終了行]
- 理由: [なぜ必要か]

### ボタンごと生成の実装箇所
- 削除対象: generateAndCacheUiBuckets の事前生成ロジック
- 追加対象: ボタン押下時の個別生成ハンドラ
```

【エージェント3: バグ検証官】
- 役割: 3大バグの解決を検証する専門家
- タスク:
  1. プロンプトv3で「日英乖離」が解決できるか検証
  2. **【更新】「操作しないと変わらない」→ ボタンごと生成方式で解決**
  3. プロンプトv3で「名詞認識エラー」が解決できるか検証
  4. 解決できないバグがあれば追加の修正案を提示
- 出力形式:
```
### バグ解決状況
| バグ | v3で解決 | 備考 |
|-----|---------|-----|
| 日英乖離 | ✅/❌/⚠️ | ... |
| 操作しないと変わらない | ✅ | ボタンごと生成方式で解決 |
| 名詞認識エラー | ✅/❌/⚠️ | ... |

### 追加修正案（解決できないバグ用）
- ...
```

【エージェント4: 副作用検証官】
- 役割: 影響範囲・副作用の専門家
- タスク:
  1. 型定義変更（TranslationResult）の影響範囲を調査
  2. プロンプト変更による出力形式変更の影響を調査
  3. 新規関数（checkAlignmentScore）追加の影響を調査
  4. **【新規】事前生成ロジック削除の影響を調査**
  5. 以下の関連関数が正常動作するか検証:
     - translatePartial（PARTIAL_SYSTEM_PROMPT使用）
     - translateWithGuard（translateFull呼び出し）
     - generateAndCacheUiBuckets（**削除予定**）
     - shouldFallbackToFull（ガード関数）
     - parseJsonResponse（JSON解析）
     - applyEvaluationWordGuard（後処理）
     - applyReverseTranslationGuard（後処理）
  6. パフォーマンスへの影響を評価（**事前生成廃止によるAPI負荷軽減**）
- 出力形式:
```
### 影響範囲調査
| 関数/コンポーネント | 影響 | 対応要否 | 詳細 |
|-------------------|------|---------|-----|
| translatePartial | ✅/⚠️/❌ | 要/不要 | ... |
| parseJsonResponse | ✅/⚠️/❌ | 要/不要 | ... |
| generateAndCacheUiBuckets | 🗑️ 削除 | 要 | ボタンごと生成に移行 |
| ... | ... | ... | ... |

### 副作用リスク
| リスク | レベル | 対策 |
|-------|-------|-----|
| [リスク内容] | 高/中/低 | [対策] |

### パフォーマンス影響
- 事前生成廃止により初期ロード高速化
- APIコスト削減（使用時のみ生成）
- ボタン押下時に待機時間発生（1-2秒）
```

【エージェント5: 品質管理者（オーケストレーター）】
- 役割: 全体を俯瞰して最終判断を下すリーダー
- タスク:
  1. 全エージェントの結果を統合
  2. 優先度をつける（高/中/低）
  3. Claude Codeに渡す最終的な実装指示を作成
  4. テストケースを提案
- 出力形式:
```
### 総合評価
⭐⭐⭐⭐☆（5段階）

### 実装前に必要な修正
| 優先度 | 内容 | 担当箇所 |
|-------|-----|---------|
| 🔴高 | ... | ... |
| 🟡中 | ... | ... |
| 🟢低 | ... | ... |

### テストケース
1. [テスト内容] → [期待結果]
2. ...

### 最終判断
✅ 実装に進んでOK
または
⚠️ 以下を修正してから実装: [内容]

### Claude Code用 最終実装指示
[完全な実装指示をここに出力]
```

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 分析対象の3大バグ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【バグ1: 日英乖離】🔴最重要
- 現象: 日本語（逆翻訳）は変わるが英語（翻訳）は同じ
- 例: スライダー50% → 日本語「やあ！」/ 英語「Hello」（英語が変わらない）
- v3での対策: checkAlignmentScore関数で一致度チェック

【バグ2: 操作しないと変わらない】🔴最重要 → ✅ 設計変更で解決
- 現象: スライダー操作時に翻訳が更新されない
- 原因: 事前生成完了前にスライダー操作される
- **【解決策】ボタンごとに生成方式に変更**
  - 事前生成（5種類一括）を廃止
  - ユーザーがボタン（フォーマル/カジュアル等）を押した時点で生成
  - その時点のスライダー値を使用するので食い違いが起きない
  - APIコストも削減（使わないトーンは生成しない）

【バグ3: 名詞認識エラー】🟡中
- 現象: 「おうた」→「singing」と誤認
- 原因: 固有名詞と一般名詞の区別ができていない
- v3での対策: NER（名詞識別）をプロンプトに追加

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🆕 設計変更: ボタンごとに生成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【現在の問題】
```
ユーザーが入力
  ↓
5種類のトーン（フォーマル〜カジュアル）を事前生成開始
  ↓
生成完了前にユーザーがスライダー操作
  ↓
事前生成は古いスライダー値で完了 → 表示との食い違い
```

【新しい設計】
```
ユーザーが入力（この時点では翻訳しない）
  ↓
ユーザーが「フォーマル」ボタンを押す
  ↓
その時点のスライダー値を取得
  ↓
APIに「フォーマル + スライダー値」で1つだけ生成依頼
  ↓
結果を表示（1-2秒待機）
```

【メリット】
- ✅ スライダー問題が根本解決（押した時点の値を使う）
- ✅ APIコスト削減（使わないトーンは生成しない）
- ✅ 初期表示が速い（5種類待たなくていい）
- ✅ コードがシンプル（事前キャッシュロジック不要）

【デメリット】
- ⚠️ ボタン押下時に1-2秒の待機（許容範囲）

【実装変更点】
1. `generateAndCacheUiBuckets` 関数を削除または無効化
2. 各トーンボタンに個別のonClickハンドラを追加
3. クリック時に `translateFull` を呼び出し（1種類のみ）
4. ローディング状態の表示を追加

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📂 参照すべきファイル
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【GitHubリポジトリ】
https://github.com/Kohei25-gif/nijilingo-ai-knowledge

【プロンプトv3関連】
- 実装指示: reference/claude_code_implementation_prompt.md
- プロンプト全文: reference/improved_prompt_v3_complete.md
- 8大テクニック: reference/プロンプトエンジニアリング8大テクニック.md

【最新コード】
- 翻訳ロジック（修正対象）: src/groq_日本語ベース.ts
- メインアプリ: src/App_日本語ベース.tsx

【既存分析】
- 設計ガイドv2: reference/NijiLingo翻訳システム設計ガイド_v2.md
- バグ1分析: analysis/bug-1-politeness-level.md
- バグ2分析: analysis/bug-2-background-race.md
- バグ3分析: analysis/bug-3-modality-change.md

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏗️ システム構成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────┐
│                       ユーザー層                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  入力フォーム │  │ トーンスライダー │  │  翻訳表示部  │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                  アプリケーション層                      │
│  ┌─────────────────────────────────────────────────┐   │
│  │              App.tsx (メインアプリ)              │   │
│  │  ┌──────────────┐  ┌──────────────────────────┐ │   │
│  │  │ 🗑️事前生成管理 │  │ キャッシュ管理システム    │ │   │
│  │  │ (generateAnd │  │ (UI Buckets)             │ │   │
│  │  │  CacheUiBuckets│  │ → 簡素化               │ │   │
│  │  │  → 削除      │  │                          │ │   │
│  │  └──────────────┘  └──────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────┐   │   │
│  │  │ 🆕 ボタンごと生成ハンドラ                 │   │   │
│  │  │ (onToneButtonClick)                      │   │   │
│  │  └──────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                        API層                            │
│  ┌─────────────────────────────────────────────────┐   │
│  │           groq.ts (翻訳APIモジュール)            │   │
│  │  ┌──────────────┐  ┌──────────────────────────┐ │   │
│  │  │ プロンプト   │  │ Gemini APIクライアント    │ │   │
│  │  │ ビルダー     │  │ (callGeminiAPI)          │ │   │
│  │  └──────────────┘  └──────────────────────────┘ │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 副作用チェック対象
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【型定義変更の影響】
- TranslationResultを使っている箇所は全て互換性あるか？
- analysisフィールド追加で壊れる箇所はないか？
- PartialTranslationResult追加の影響は？

【プロンプト変更の影響】
- 出力形式変更でparseJsonResponseが壊れないか？
- 既存のガード関数は正常動作するか？

【関数追加の影響】
- checkAlignmentScoreが既存フローを阻害しないか？
- パフォーマンスへの影響は許容範囲か？

【事前生成廃止の影響】 🆕
- generateAndCacheUiBuckets を呼び出している箇所
- UI Bucketsキャッシュの依存箇所
- 5種類同時表示のUI部分（あれば）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 制約条件
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【壊してはいけない機能】
- トーンスライダー（0/50/100）の動作
- ~~キャッシュシステム（L1キャッシュ）~~ → 簡素化OK
- PARTIAL/FALLBACK翻訳フロー
- 日本語ベース方式の翻訳パイプライン
- 既存の型定義との互換性

【非ゴール】
- UIデザイン変更
- 新規画面追加
- APIエンドポイント変更

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📤 最終出力
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

全エージェントの分析結果を統合して、以下を出力してください：

1. **総合評価**（5段階）
2. **各バグの解決状況**（✅/❌/⚠️）
3. **副作用・影響範囲の評価**
4. **必要な修正一覧**（優先度順）
5. **テストケース**
6. **Claude Code用 完全な実装指示**（ボタンごと生成を含む）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
依頼者: ベニー & きみちゃん
日付: 2025年1月30日
緊急度: 🔴 高
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1 | 2025-01-29 | 初版作成（5エージェント構成） |
| v2 | 2025-01-30 | 「ボタンごとに生成」方針を追加。バグ2の解決策を設計変更に変更 |
