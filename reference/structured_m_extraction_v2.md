# 構造化M抽出 v2（拡張ハイブリッド版）

**作成日:** 2026-02-03
**ステータス:** 設計完了、実装待ち

## 概要

翻訳前に日本語から構造情報を抽出し、翻訳時に意味を固定する。
旧ハイブリッド版（3項目）を拡張し、7項目で意味のズレを防ぐ。

---

## スキーマ定義

```typescript
// 意図タイプ
type IntentType = '依頼' | '確認' | '報告' | '質問' | '感謝' | '謝罪' | '提案' | '命令' | 'その他';

// 確信度
type CertaintyLevel = '確定' | '推測' | '可能性' | '希望';

// 固有名詞タイプ
type EntityType = 'person' | 'place' | 'org' | 'product';

interface ExpandedStructure {
  // === 基本3項目（旧ハイブリッド） ===
  主題: string;           // 何について
  動作: string;           // 何をする/どうなる
  意図: IntentType;       // 発話の目的
  
  // === 追加4項目 ===
  主語: string;           // 誰が（省略時は推定、不明なら「不明」）
  対象: string;           // 誰に/何に（なければ「なし」）
  確信度: CertaintyLevel; // 話者の確信の度合い
  固有名詞: Array<{       // 誤認識しやすい名詞
    text: string;
    type: EntityType;
    読み?: string;        // ひらがな名詞の場合
  }>;
}
```

---

## 抽出例

### 例1: 固有名詞の認識

**入力:** 「おうたが寝てから向かいます」

```json
{
  "主題": "移動",
  "動作": "向かう",
  "意図": "報告",
  "主語": "私",
  "対象": "なし",
  "確信度": "確定",
  "固有名詞": [{ "text": "おうた", "type": "person", "読み": "Outa" }]
}
```

### 例2: 依頼の意図保持

**入力:** 「明日の会議の資料を送ってもらえる？」

```json
{
  "主題": "会議の資料",
  "動作": "送る",
  "意図": "依頼",
  "主語": "相手",
  "対象": "私",
  "確信度": "確定",
  "固有名詞": []
}
```

### 例3: 確信度の保持

**入力:** 「電車止まってるかも」

```json
{
  "主題": "電車",
  "動作": "止まっている",
  "意図": "報告",
  "主語": "電車",
  "対象": "なし",
  "確信度": "可能性",
  "固有名詞": []
}
```

### 例4: 謝罪 + 理由

**入力:** 「遅れてごめん、電車が止まってた」

```json
{
  "主題": "遅刻",
  "動作": "遅れる",
  "意図": "謝罪",
  "主語": "私",
  "対象": "相手",
  "確信度": "確定",
  "固有名詞": []
}
```

### 例5: 提案

**入力:** 「明日飲みに行かない？」

```json
{
  "主題": "飲み会",
  "動作": "行く",
  "意図": "提案",
  "主語": "私たち",
  "対象": "なし",
  "確信度": "確定",
  "固有名詞": []
}
```

---

## プロンプト変換

抽出した構造情報を翻訳プロンプトに渡す形式：

```typescript
function structureToPromptText(s: ExpandedStructure): string {
  const entities = s.固有名詞.length > 0
    ? s.固有名詞.map(e => 
        `「${e.text}」は${e.type === 'person' ? '人名' : e.type === 'place' ? '地名' : e.type === 'org' ? '組織名' : '製品名'}${e.読み ? `（${e.読み}）` : ''}`
      ).join('、')
    : 'なし';

  return `【構造情報】
・主語: ${s.主語}
・動作: ${s.動作}
・対象: ${s.対象}
・意図: ${s.意図}
・確信度: ${s.確信度}
・固有名詞: ${entities}

※ 上記の「意図」「確信度」「固有名詞」を翻訳で必ず保持すること`;
}
```

---

## 旧版との比較

| 項目 | 旧ハイブリッド（v1） | 拡張版（v2） |
|------|---------------------|--------------|
| 主題 | ✅ | ✅ |
| 動作 | ✅ | ✅ |
| 意図 | ✅ | ✅ |
| 主語 | ❌ | ✅ |
| 対象 | ❌ | ✅ |
| 確信度 | ❌ | ✅ |
| 固有名詞 | ❌ | ✅ |
| **合計** | 3項目 | 7項目 |

---

## 解決できる問題

| 問題 | 対応する項目 | 例 |
|------|-------------|-----|
| 固有名詞の誤認識 | 固有名詞 | 「おうた」→「singing」ではなく「Outa」 |
| 主語の勝手な追加/間違い | 主語 | 「行きます」→ I/He/We を明示 |
| 対象の曖昧さ | 対象 | 「送って」→ 誰に送るか |
| ニュアンス消失 | 確信度 | 「かも」→ "might" を保持 |
| 意図の変質 | 意図 | 依頼→確認に変わるのを防止 |

---

## 抽出プロンプト（案）

```
あなたは日本語の構造分析アシスタントです。
入力された日本語から、以下の7項目を抽出してください。

【抽出項目】
1. 主題: 何について話しているか
2. 動作: 何をするか/どうなるか
3. 意図: 依頼/確認/報告/質問/感謝/謝罪/提案/命令/その他
4. 主語: 誰が（省略されていれば推定、不明なら「不明」）
5. 対象: 誰に/何に（なければ「なし」）
6. 確信度: 確定/推測/可能性/希望
7. 固有名詞: 人名/地名/組織名/製品名のリスト（ひらがな名詞は読みも）

【出力形式】
JSONのみ（説明不要）

【例】
入力: 「おうたが寝てから向かいます」
{"主題":"移動","動作":"向かう","意図":"報告","主語":"私","対象":"なし","確信度":"確定","固有名詞":[{"text":"おうた","type":"person","読み":"Outa"}]}
```

---

## 実装メモ

- 抽出APIは`extractStructure()`関数
- キャッシュは500件まで保持（旧版と同じ）
- 抽出失敗時はデフォルト値を返す（翻訳を止めない）

---

## 次のステップ

1. [ ] `groq.ts`に`ExpandedStructure`インターフェース追加
2. [ ] `extractStructure()`を7項目対応に更新
3. [ ] `structureToPromptText()`を更新
4. [ ] `translateFull()`と`editJapaneseForTone()`に統合
5. [ ] テスト（5つの例文で検証）
