// ============================================
// NijiLingo ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
// ä¿å­˜æ—¥: 2026-02-02
// 
// å°†æ¥ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å†å®Ÿè£…ã™ã‚‹æ™‚ã®ãŸã‚ã«ä¿å­˜
// ============================================

const TUTORIAL_STEPS: { target: string | string[] | null; message: string; button: string | null }[] = [
  {
    target: null,
    message:
      'ğŸŒˆ ã‚ˆã†ã“ãã€NijiLingoï¼\né€ã‚‹å‰ã®æ–‡ç« ã‚’ã€ç¿»è¨³ï¼†ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹èª¿æ•´ã€‚\né€†ç¿»è¨³ã§ã€Œã©ã†èã“ãˆã‚‹ï¼Ÿã€ã‚‚ãƒã‚§ãƒƒã‚¯ğŸ‘€\nâ€»é€ä¿¡ã¯ã—ã¾ã›ã‚“ã€‚ã‚³ãƒ”ãƒ¼ã—ã¦LINEç­‰ã«è²¼ã£ã¦é€ã£ã¦ã­ğŸ“‹',
    button: 'ã¯ã˜ã‚ã‚‹',
  }, // 0
  {
    target: 'add-partner-btn',
    message: 'ã¾ãšã¯è©±ã—ç›¸æ‰‹ã‚’è¿½åŠ ã—ã‚ˆã†ï¼\nï¼ˆé€£çµ¡å…ˆã˜ã‚ƒãªãã¦ã€Œç¿»è¨³ã®ç›¸æ‰‹è¨­å®šã€ã ã‚ˆï¼‰\nå³ä¸Šã®ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—âœ¨',
    button: null,
  }, // 1
  {
    target: ['partner-name-input', 'partner-language-select', 'save-partner-btn'],
    message: 'åå‰ã¯ãƒ¡ãƒ¢ç”¨ã§OKğŸ‘Œ\nè¨€èªã¯ã€Œç›¸æ‰‹ãŒè©±ã™è¨€èªã€ã‚’é¸ã‚“ã§ã­ğŸŒ\nã§ããŸã‚‰ã€Œè¿½åŠ ã€ï¼',
    button: null,
  }, // 2
  {
    target: 'partner-message-btn',
    message: 'ç›¸æ‰‹ã‹ã‚‰æ¥ãŸæ–‡ã‚’å…¥ã‚Œã¦ã¿ã‚ˆã†ğŸ“©\nã‚³ãƒ”ãƒšã§ã‚‚OKï¼',
    button: null,
  }, // 3
  {
    target: 'partner-message-add-btn',
    message: 'ã“ã®æ–‡ã‚’ã€Œç›¸æ‰‹ã®ç™ºè¨€ã€ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã‚ˆã€‚\nã§ããŸã‚‰ã€Œè¿½åŠ ã€âœ…',
    button: null,
  }, // 4
  {
    target: ['message-input', 'convert-btn'],
    message: 'æ¬¡ã¯ã‚ãªãŸã®è¿”äº‹âœï¸\næ—¥æœ¬èªã§å…¥åŠ› â†’ã€Œå¤‰æ›ã€\né€†ç¿»è¨³ã§ä¼ã‚ã‚Šæ–¹ã‚‚ç¢ºèªã—ã‚ˆã†',
    button: null,
  }, // 5
  {
    target: 'tone-buttons',
    message: 'ãƒˆãƒ¼ãƒ³ã§è¨€ã„æ–¹ãƒã‚§ãƒ³ã‚¸ğŸ›ï¸\nã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¼·ã•ã‚‚èª¿æ•´ã§ãã‚‹ã‚ˆ',
    button: null,
  }, // 6
  {
    target: 'copy-btn',
    message: 'ã“ã“ã¯é€ä¿¡ã˜ã‚ƒãªãã¦ã€Œã‚³ãƒ”ãƒ¼ã€ğŸ“‹\nã‚³ãƒ”ãƒ¼ã—ãŸæ–‡ã‚’LINEç­‰ã«è²¼ã£ã¦é€ã£ã¦ã­',
    button: null,
  }, // 7
  {
    target: 'explanation-toggle',
    message: 'â–¼è§£èª¬ã§ã€Œã©ã†èã“ãˆã‚‹ï¼Ÿã€ãŒåˆ†ã‹ã‚‹ã‚ˆã€‚\næ°—ã«ãªã£ãŸã‚‰æ–‡ç« ã‚’ç›´ã—ã¦ã€ã‚‚ã†ä¸€å›å¤‰æ›ï¼',
    button: 'æ¬¡ã¸',
  }, // 8
  {
    target: 'face-to-face-btn',
    message: 'å¯¾é¢ãƒ¢ãƒ¼ãƒ‰ã¯ã€ãã®å ´ã®ä¼šè©±ã‚’ç¿»è¨³ğŸ¤\næ—…è¡Œãƒ»æ¥å®¢ãƒ»åˆå¯¾é¢ã§ä¾¿åˆ©ï¼',
    button: 'æ¬¡ã¸',
  }, // 9
  {
    target: null,
    message: 'æº–å‚™OKğŸ‰\nâ‘  ç›¸æ‰‹ã‚’è¿½åŠ \nâ‘¡ ç›¸æ‰‹ã®æ–‡ã‚’å…¥ã‚Œã‚‹\nâ‘¢ è¿”äº‹ã‚’å¤‰æ›\nâ‘£ ã‚³ãƒ”ãƒ¼ã—ã¦é€ã‚‹\nç›¸æ‰‹è¨­å®šã¯âš™ï¸ã‹ã‚‰ã„ã¤ã§ã‚‚å¤‰æ›´OK',
    button: 'å§‹ã‚ã‚‹',
  }, // 10
];

// ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
interface TutorialOverlayProps {
  tutorialStep: number;
  onSkip: () => void;
  onNext: () => void;
  expandedExplanation: number | string | null;
}

const TutorialOverlay: React.FC<TutorialOverlayProps> = ({
  tutorialStep,
  onSkip,
  onNext,
  expandedExplanation,
}) => {
  const [tooltipStyle, setTooltipStyle] = useState<React.CSSProperties>({});

  const isActive = tutorialStep >= 0 && tutorialStep < TUTORIAL_STEPS.length;
  const step = isActive ? TUTORIAL_STEPS[tutorialStep] : null;

  useEffect(() => {
    // å…¨ã¦ã®è¦ç´ ã‹ã‚‰ã‚¯ãƒ©ã‚¹å‰Šé™¤
    document.querySelectorAll('.tutorial-target').forEach(el => {
      el.classList.remove('tutorial-target');
    });

    if (!isActive || !step) return;

    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;
    // å¹ãå‡ºã—ã¯å°‘ã—åºƒã‚ã«ã—ã¦ã€ä¸è‡ªç„¶ãªæ”¹è¡Œã‚’æ¸›ã‚‰ã™ï¼ˆã‚¹ãƒãƒ›å¹…ã«åˆã‚ã›ã¦å¯å¤‰ï¼‰
    const bubbleWidth = Math.min(320, viewportWidth - 32);

    // Step 2ï¼ˆåå‰+è¨€èª+è¿½åŠ ï¼‰ã¯è¿½åŠ ãƒœã‚¿ãƒ³ã®ä¸‹ã«å¹ãå‡ºã—å›ºå®š
    if (tutorialStep === 2 && Array.isArray(step.target)) {
      const targets = step.target;
      targets.forEach(targetId => {
        const el = document.getElementById(targetId);
        if (el) {
          el.classList.add('tutorial-target');
        }
      });

      // è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆæœ€å¾Œã®è¦ç´ ï¼‰ã®ä¸‹ã«é…ç½®
      const saveBtn = document.getElementById('save-partner-btn');
      if (saveBtn) {
        const rect = saveBtn.getBoundingClientRect();
        const left = Math.max(
          16,
          Math.min(rect.left + rect.width / 2 - bubbleWidth / 2, viewportWidth - bubbleWidth - 16)
        );
        setTooltipStyle({
          position: 'fixed',
          top: rect.bottom + 16,
          left,
        });
        return;
      }
    }

    // Step 3ï¼ˆç›¸æ‰‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¬„ï¼‰ã¯ä¸‹ã«é…ç½®
    if (tutorialStep === 3) {
      const el = document.getElementById('partner-message-btn');
      if (el) {
        el.classList.add('tutorial-target');
        const rect = el.getBoundingClientRect();
        const left = Math.max(16, Math.min(rect.left, viewportWidth - bubbleWidth - 16));
        setTooltipStyle({
          position: 'fixed',
          top: rect.bottom + 16,
          left,
        });
        return;
      }
    }

    // Step 4ï¼ˆç›¸æ‰‹æ–‡ã®è¿½åŠ ï¼‰ã¯å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã¨è¢«ã‚Šã‚„ã™ã„ã®ã§ã€å³ä¸Šã«é€ƒãŒã™
    if (tutorialStep === 4) {
      const el = document.getElementById('partner-message-add-btn');
      if (el) {
        el.classList.add('tutorial-target');
      }
      setTooltipStyle({
        position: 'fixed',
        top: 120,
        right: 16,
        left: 'auto',
      });
      return;
    }

    // Step 5ï¼ˆè‡ªåˆ†ã®è¿”äº‹å…¥åŠ›ï¼‰ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã§è¢«ã‚Šã‚„ã™ã„ã®ã§ã€ä¸Šã«å›ºå®š
    if (tutorialStep === 5 && Array.isArray(step.target)) {
      const targets = step.target;
      targets.forEach(targetId => {
        const el = document.getElementById(targetId);
        if (el) {
          el.classList.add('tutorial-target');
        }
      });

      setTooltipStyle({
        position: 'fixed',
        top: 140,
        left: '50%',
        transform: 'translateX(-50%)',
      });
      return;
    }

    // Step 6ï¼ˆãƒˆãƒ¼ãƒ³ï¼‰ã¯ã‚³ãƒ”ãƒ¼ä»˜è¿‘ã¨è¢«ã‚Šã‚„ã™ã„ã®ã§ã€å°‘ã—ä¸Šã«é…ç½®
    if (tutorialStep === 6) {
      const el = document.getElementById('tone-buttons');
      if (el) {
        el.classList.add('tutorial-target');
        const rect = el.getBoundingClientRect();
        const top = Math.max(16, rect.top - 280);
        setTooltipStyle({
          position: 'fixed',
          top,
          left: '50%',
          transform: 'translateX(-50%)',
        });
        return;
      }
    }

    // Step 8ï¼ˆè§£èª¬ï¼‰ã§è§£èª¬ãŒã¾ã é–‹ã„ã¦ãªã„æ™‚ã¯ã€è§£èª¬ãƒœã‚¿ãƒ³ã®ä¸‹ã«é…ç½®
    if (tutorialStep === 8 && expandedExplanation === null) {
      const el = document.getElementById('explanation-toggle');
      if (el) {
        el.classList.add('tutorial-target');
        const rect = el.getBoundingClientRect();
        setTooltipStyle({
          position: 'fixed',
          top: rect.bottom + 48,
          left: '50%',
          transform: 'translateX(-50%)',
        });
        return;
      }
    }

    // Step 8ã§è§£èª¬ãŒé–‹ã„ã¦ã‚‹æ™‚ã¯ã€å·¦ä¸‹ã«ç§»å‹•ï¼ˆè§£èª¬ãƒ†ã‚­ã‚¹ãƒˆã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
    if (tutorialStep === 8 && expandedExplanation !== null) {
      setTooltipStyle({
        position: 'fixed',
        bottom: 140,
        left: 12,
      });
      return;
    }

    // Step 9ï¼ˆå¯¾é¢ãƒ¢ãƒ¼ãƒ‰ï¼‰ã¯å¯¾é¢ãƒœã‚¿ãƒ³ã®ä½ç½®ã«å›ºå®š
    if (tutorialStep === 9) {
      const faceToFaceBtn = document.getElementById('face-to-face-btn');
      if (faceToFaceBtn) {
        const rect = faceToFaceBtn.getBoundingClientRect();
        faceToFaceBtn.classList.add('tutorial-target');
        setTooltipStyle({
          position: 'fixed',
          top: rect.bottom + 48,
          right: 16,
          left: 'auto',
        });
        return;
      }
    }

    if (!step.target) {
      setTooltipStyle({
        position: 'fixed',
        top: '50%',
        left: '50%',
        transform: 'translate(-50%, -50%)',
      });
      return;
    }

    // targetãŒé…åˆ—ã‹å˜ä¸€ã‹ã§å‡¦ç†ã‚’åˆ†ã‘ã‚‹
    const targets = Array.isArray(step.target) ? step.target : [step.target];

    targets.forEach(targetId => {
      const el = document.getElementById(targetId);
      if (el) {
        el.classList.add('tutorial-target');
      }
    });

    // å¹ãå‡ºã—ä½ç½®ã¯æœ€å¾Œã®è¦ç´ ã‚’åŸºæº–ã«
    const lastTarget = targets[targets.length - 1];
    const el = document.getElementById(lastTarget);
    if (el) {
      // å¹ãå‡ºã—ä½ç½®è¨ˆç®—
      const rect = el.getBoundingClientRect();

      // å³å´ã®è¦ç´ ã¯å¹ãå‡ºã—ã‚’å·¦å¯„ã‚Šã«é…ç½®
      let leftPos: number;
      if (rect.left > viewportWidth / 2) {
        leftPos = Math.max(16, rect.left + rect.width / 2 - bubbleWidth + 40);
      } else {
        leftPos = Math.max(16, Math.min(rect.left + rect.width / 2 - bubbleWidth / 2, viewportWidth - bubbleWidth - 16));
      }

      if (rect.top < viewportHeight / 2) {
        setTooltipStyle({
          position: 'fixed',
          top: rect.bottom + 16,
          left: leftPos,
        });
      } else {
        setTooltipStyle({
          position: 'fixed',
          bottom: viewportHeight - rect.top + 16,
          left: leftPos,
        });
      }
    }

    return () => {
      document.querySelectorAll('.tutorial-target').forEach(el => {
        el.classList.remove('tutorial-target');
      });
    };
  }, [tutorialStep, isActive, step, expandedExplanation]);

  if (!isActive || !step) return null;

  return (
    <div className="tutorial-overlay">
      <div
        className={`tutorial-bubble ${step.target ? '' : 'tutorial-bubble-center'}`}
        style={{
          ...tooltipStyle,
          width: 'min(320px, calc(100vw - 32px))',
          maxWidth: 'min(320px, calc(100vw - 32px))',
          boxSizing: 'border-box',
        }}
      >
        <p
          className="tutorial-message"
          style={{ whiteSpace: 'pre-line', textAlign: 'left', lineHeight: 1.5 }}
        >
          {step.message}
        </p>
        <div className="tutorial-buttons">
          <button onClick={onSkip} className="tutorial-skip-btn">ã‚¹ã‚­ãƒƒãƒ—</button>
          {step.button && (
            <button onClick={onNext} className="tutorial-next-btn">{step.button}</button>
          )}
        </div>
      </div>
    </div>
  );
};

// ============================================
// Appå†…ã®stateãƒ»ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆfunction App()å†…ã«å…¥ã‚Œã‚‹ï¼‰
// ============================================

/*
  // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç®¡ç†
  const [tutorialStep, setTutorialStep] = useState<number>(() => {
    const done = localStorage.getItem('nijilingo_tutorial_done');
    return done ? -1 : 0;
  });

  const handleTutorialSkip = () => {
    setTutorialStep(-1);
    localStorage.setItem('nijilingo_tutorial_done', 'true');
  };

  const handleTutorialNext = () => {
    if (tutorialStep >= TUTORIAL_STEPS.length - 1) {
      handleTutorialSkip();
    } else {
      setTutorialStep(tutorialStep + 1);
    }
  };
*/

// ============================================
// JSXä½¿ç”¨ç®‡æ‰€ï¼ˆreturnã®ä¸­ï¼‰
// ============================================

/*
      <TutorialOverlay
        tutorialStep={tutorialStep}
        onSkip={handleTutorialSkip}
        onNext={handleTutorialNext}
        expandedExplanation={expandedExplanation}
      />
*/

// ============================================
// å„æ‰€ã®tutorialStepå‚ç…§ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å†…ãªã©ï¼‰
// ============================================

/*
if (tutorialStep === 1) setTutorialStep(2);
if (tutorialStep === 2) setTutorialStep(3);
if (tutorialStep === 3) setTutorialStep(4);
if (tutorialStep === 4) setTutorialStep(5);
if (tutorialStep === 5) setTutorialStep(6);
if (tutorialStep === 6) setTutorialStep(7);
if (tutorialStep === 7) setTutorialStep(8);

autoFocus={tutorialStep < 0}
*/

// ============================================
// CSSï¼ˆApp.cssã«ã‚ã‚‹ï¼‰
// ============================================

/*
.tutorial-overlay { ... }
.tutorial-bubble { ... }
.tutorial-bubble-center { ... }
.tutorial-message { ... }
.tutorial-buttons { ... }
.tutorial-skip-btn { ... }
.tutorial-next-btn { ... }
.tutorial-target { ... }
*/
