# 2026-01-29 検証ログ

## 📌 検証対象コード

| リポジトリ | コミット | 内容 |
|-----------|---------|------|
| NijiChat (Vercel) | `885b3dd` | クロちゃん修正: プロンプトv3 + ボタンごと生成 |
| nijilingo-ai-knowledge | `635aa03` | 同上（きみちゃん用にコピー） |

**コードの場所:**
- https://github.com/Kohei25-gif/nijilingo-ai-knowledge/tree/635aa03/src

---

## 📝 テスト文章

1. その服素敵だね
2. 遅れてごめん、電車が止まってた
3. 明日の会議の資料を送ってもらえる

---

## ✅ 確認ポイント

1. **ボタンごと生成になってるか** → ボタン押すまで翻訳されない
2. **スライダー動かしてからボタン押すと反映されるか** → 日英乖離問題
3. **名詞認識エラー** → 「おうた」などが正しく認識されるか

---

## 🔍 コード分析結果（ベンが検証）

### 問題1: 事前生成が残っている ❌

**箇所:** 920-1030行目付近

```javascript
// ChatScreen: 入力が止まって500ms後に事前生成開始（Nani方式）
useEffect(() => {
  ...
  await generateAndCacheUiBuckets({...})
}, [inputText, ...])
```

入力して500ms後に自動で事前生成が走る。**ボタンごと生成の設計に反している。**

---

### 問題2: 他のトーンもバックグラウンド生成 ❌

**箇所:** 1608-1618行目

```javascript
// ★ 他のトーンはバックグラウンドで遅延生成（3秒後に開始）
const otherTones = ['casual', 'business', 'formal'].filter(t => t !== toneId)
setTimeout(async () => {
  for (const tone of otherTones) {
    await fetchAllBucketsForTone(...)
  }
}, 3000)
```

カジュアル押したら → ビジネス・フォーマルも3秒後に生成開始。**不要。**

---

### 問題3: 日本語→英語の生成順序 ⚠️

**現状のフロー（順次処理）:**
```
1. レベル50: 日本語編集 → 英語翻訳 → 差分チェック → OKならbreak
2. レベル75: （50がNGの場合）日本語編集 → 英語翻訳 → ...
```

1セットずつ作って、OKが出たらbreakする。

**問題点:**
- 日本語の差分と英語の差分が別々に判定される
- 日英乖離の原因になってる可能性

**ベニー提案（先に日本語3パターン確定）:**
```
1. 日本語Lv1, Lv2, Lv3を先に全部作る（差分確定）
2. それぞれに対して英語を作る
```

→ 日本語の差分が保証される！

---

## 📋 修正が必要な箇所

| 優先度 | 箇所 | 行数 | 修正内容 |
|-------|-----|------|---------|
| 🔴高 | ChatScreen事前生成useEffect | 920-960行目 | 削除または無効化 |
| 🔴高 | TranslateScreen事前生成useEffect | 970-1030行目 | 削除または無効化 |
| 🔴高 | handleToneSelect内の他トーン生成 | 1608-1618行目 | 削除 |
| 🟡中 | 日本語→英語の生成順序 | generateAndCacheUiBuckets内 | 日本語3パターン先に確定する方式に変更 |

---

## 📊 検証結果（アプリ動作）

| テスト | 結果 | 備考 |
|-------|------|------|
| ボタンごと生成 | ⏳ | コード上は事前生成が残っている |
| スライダー反映 | ⏳ | |
| 名詞認識 | ⏳ | |

---

## 💡 今日の気づき・議論

### 日本語→英語の生成順序について

**現状:** 順次処理（1セットずつ作ってOKならbreak）
**問題:** 日英乖離の原因になってる可能性
**提案:** 日本語3パターンを先に確定してから英語を作る

これについてはシュワちゃんに分析させるか、きみちゃんと相談する予定。

---

*検証者: ベニー*
*分析: ベン*
*日時: 2026-01-29 14:00頃*
