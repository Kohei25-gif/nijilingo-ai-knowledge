# 2026-01-29 検証ログ

## 📌 検証対象コード

| リポジトリ | コミット | 内容 |
|-----------|---------|------|
| NijiChat (Vercel) | `885b3dd` | クロちゃん修正: プロンプトv3 + ボタンごと生成 |
| nijilingo-ai-knowledge | `635aa03` | 同上（きみちゃん用にコピー） |

**コードの場所:**
- https://github.com/Kohei25-gif/nijilingo-ai-knowledge/tree/635aa03/src

---

## 🔍 コード分析結果（ベンが検証）

### 問題1: 事前生成が残っている ❌

**箇所:** 920-1030行目付近

```javascript
// ChatScreen: 入力が止まって500ms後に事前生成開始（Nani方式）
useEffect(() => {
  ...
  await generateAndCacheUiBuckets({...})
}, [inputText, ...])
```

入力して500ms後に自動で事前生成が走る。**ボタンごと生成の設計に反している。**

---

### 問題2: 他のトーンもバックグラウンド生成 ❌

**箇所:** 1608-1618行目

カジュアル押したら → ビジネス・フォーマルも3秒後に生成開始。**不要。**

---

### 問題3: prefetchStatusのUI表示 ❌

**箇所:** 3004-3010行目、3524-3530行目

事前生成削除したらステータス更新されなくなるので、UI表示も削除必要。

---

### 問題4: 日本語→英語の生成順序 ⚠️

**現状:** 順次処理（1セットずつ作ってOKならbreak）
**問題:** 日英乖離の原因になってる可能性
**提案:** 日本語3パターンを先に確定してから英語を作る

---

## 📋 修正プロンプト作成

**ファイル:** `reference/claude_code_fix_prompt_v4.md`

### 修正内容（4つ）

| # | 修正内容 | 箇所 |
|---|---------|------|
| 1 | 事前生成useEffect削除 | 920-1030行目 |
| 2 | prefetchStatus関連UI削除 | 3004-3010, 3524-3530行目 |
| 3 | 他トーンバックグラウンド生成削除 | 1608-1618行目 |
| 4 | 日本語→英語の生成順序変更 | 1180-1350行目 |

---

## 🔍 v1.7検証結果

| 項目 | 結果 |
|-----|------|
| ❌ 確定で壊れる | 0件 |
| ⚠️ 高リスク | 0件（対策済み） |
| ？ 未確認 | 0件（確認済み） |

**✅ 収束**

---

## 💡 今日の気づき・議論

### 日本語→英語の生成順序について（ベニー発案）

**現状:** 順次処理（1セットずつ作ってOKならbreak）
- 50%の日本語+英語を作る → OKならbreak
- NGなら75%を試す...

**問題点:**
- 日本語の差分と英語の差分が別々に判定される
- 日英乖離の原因になってる可能性

**ベニー提案（採用）:**
1. 日本語を3パターン（0%, 50%, 100%）先に確定
2. それぞれに対して英語を作る
3. → 日本語の差分が保証される！

---

## 📁 作成したファイル

| ファイル | 内容 |
|---------|------|
| `reference/claude_code_fix_prompt_v4.md` | 修正プロンプト（v1.7検証済み） |

---

## ⏭️ 次のステップ

1. きみちゃんに修正プロンプトを共有
2. クロちゃんで実装（tmuxで見える化）
3. 検証

---

*検証者: ベニー*
*分析: ベン*
*日時: 2026-01-29 14:30頃*
